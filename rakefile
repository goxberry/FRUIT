require 'rake/clean'
require 'rubygems'
require 'fruit_processor'

include Rake::DSL if defined?(Rake::DSL)

$base_dir=Dir.pwd
$build_dir = "#{$base_dir}/build"

task :default => [
  :ruby_test, :rake_estimate_test, 
  :in_3_minutes,
  :sample_selective, 
  :anchor_root, :dirs, :compile, :sample, 
  :self_test]

# :test is not included as :self_test covers tests done in :test.
# :sample_single_dir is not included
#    because fortran compiler must recognize .f95 extension.

if ENV['DISPLAY']
  task :default => [ :gui_fruit_test ]
end

CLEAN.include(FileList['**/*.o', '**/*.mod', '**/*.a', '**/*_gen.f90', '**/*fruit_driver',
  '**/result*.xml',
  '**/fruit_driver_fxx.exe',
  '**/rakefile_gui_tmp',
  '**/rakefile_gui_tester',
  '**/rakefile_gui_src',
  '**/fruit_driver_gui.exe',
  'in_3_minutes/fruit.f90',
  'in_3_minutes/fruit_util.f90',
  'sample/test/fruit.f90',
  'sample/test/fruit_util.f90',
  'sample_single_dir/fruit.f90',
  'sample_single_dir/fruit_util.f90',
  'sample_single_dir/rake_base.rb',
  'sample_single_dir/rake_estimate.rb',
  'sample_selective/fruit.f90',
  'sample_selective/fruit_util.f90',
  'sample_selective/fruit_driver_selective',
  'sample_selective/dummy_main',
  'self_test/fruit_self_test_driver',
  'self_test/override_stdout.txt',
  'self_test/fruit.f90',
  'self_test/fruit_util.f90',
  'fruit_processor_gem/pkg/fruit_processor-*/',
 ])
CLOBBER.include(FileList['src/fruit.f90'])
CLOBBER.include($build_dir)

desc "Complie src/fruit*.f90 and build build/libfruit.a"
task :compile do
  sh 'cd src;rake'
end

desc "(Obsolete) Test of fruit.f90 and fruit_util.f90."
task :test => :compile do
  sh 'cd test;rake;'
  driver_programs = FileList["#{$build_dir}/fruit_driver"]
  driver_programs.each do |driver|
    sh "\"#{driver}\""
  end
end

desc "Update fruit.f90"
task :fruit_f90 do
  sh 'cd src; rake fruit.f90'
end

desc "Self test of fruit.f90 and fruit_util.f90."
task :self_test => :compile do
  sh 'cd self_test; rake;'
end

desc "Using valgrind do Self test of fruit.f90 and fruit_util.f90."
task :self_test_valgrind => :compile do
  sh 'cd self_test; rake valgrind'
end

desc "Test of fruit_processor.rb."
task :ruby_test do
  sh 'cd fruit_processor_gem; rake test'
end

desc "Test of rake_estimate.rb"
task :rake_estimate_test do
  sh 'cd ruby_test; ruby rake_estimate_test.rb'
end

desc "Test of gui_fruit.rb"
task :gui_fruit_test do
  sh 'cd ruby_test; ruby gui_fruit_test.rb'
end

desc "Compile a sample of multi-directry test."
task :sample => :compile do
  sh 'cd sample;rake;'
end

desc "Compile a sample of manually written test."
task :in_3_minutes => :fruit_f90 do
  sh 'cd in_3_minutes;rake'
end

desc "Compile a sample of single-directry test."
task :sample_single_dir => :fruit_f90 do
  dir = "sample_single_dir"
  sh "cd #{dir}; ln -fs ../src/fruit.f90"
  sh "cd #{dir}; ln -fs ../src/fruit_util.f90"
  sh "cd #{dir}; ln -fs ../rake_base.rb"
  sh "cd #{dir}; ln -fs ../rake_estimate.rb"
  sh "cd #{dir}; rake"
end

desc "Compile a sample which complies only specifiled testerss."
task :sample_selective => :fruit_f90 do
  dir = "sample_selective"
  sh "cd #{dir}; ln -fs ../src/fruit.f90"
  sh "cd #{dir}; ln -fs ../src/fruit_util.f90"
  sh "cd #{dir}; rake"
end

load 'rake_base.rb'
include RakeBase
