require 'rubygems'
require 'fruit_processor'
require 'rake/clean'

include Rake::DSL if defined?(Rake::DSL)

$build_dir = "./"
$source_dirs = ["./", "../src/"]
$goal='fruit_self_test_driver'
$main = "fruit_driver_gen.f90"

fp = FruitProcessor.new
fp.pre_process($source_dirs)

load "../rake_estimate.rb"
load "../rake_base.rb"

task :default => [:run]

desc "Compile self-test and run"
task :run => [$goal] do
  sh ("./#{$goal}")
  File.delete("fruit_basket_gen.o")
end

desc "Using Valgrind run self-test"
task :valgrind => [$goal] do
  sh ("valgrind --leak-check=full --show-reachable=yes ./#{$goal}")
  File.delete("fruit_basket_gen.o")
end

CLEAN.include("fruit_self_test_driver", "override_stdout.txt")


