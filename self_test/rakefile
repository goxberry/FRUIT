require 'rubygems'
require 'fruit_processor'
require 'rake/clean'

include Rake::DSL if defined?(Rake::DSL)

# Add this line at the beginning if there are generated code involved
FruitProcessor.new.pre_process

$goal='fruit_self_test_driver'

# the link of the executable depends on libfruit.a.
# spefify where the files are here:
# It is in array, because order matters
$lib_bases = [
  ['fruit', FruitProcessor.new.build_dir],
]

# if $build_dir is defined, then use build_dir

task :default => [:run]

desc "Compile self-test and run"
task :run => [$goal] do
  sh ("./#{$goal}")
end

desc "Using Valgrind run self-test"
task :valgrind => [$goal] do
  sh ("valgrind --leak-check=full --show-reachable=yes ./#{$goal}")
end

CLEAN.include("fruit_self_test_driver", "override_stdout.txt")

# if one module has to be compiled after another module, specify like this:
#file ['module_b_test.o']  => 'calculator_test.o'

load "#{FruitProcessor.new.base_dir}/rake_base.rb"
include RakeBase
